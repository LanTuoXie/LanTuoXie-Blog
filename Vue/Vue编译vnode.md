# Vue编译vnode原理

[vnode编译的流程](https://juejin.cn/post/6844904181443067917)

## 模版编译原理概念

- 平时使用模板时，可以在模板中使用一些变量来填充模板，还可以在模板中使用Javascript表达式，又或者是使用一些指令等。这些功能在HTML语法中是不存在的，这多亏了模板编译赋予了模板强大的功能。
- 模板编译的主要目标就是生成渲染函数。而渲染函数的作用是每次执行它，它就会使用当前最新的状态生成一份新的vnode，然后使用这个vnode进行渲染。

## **将模板编译成渲染函数**

模板编译分三部分内容：

- 将模板解析为AST。（Abstract Syntax Tree，抽象语法树）。
- 遍历AST标记静态节点。
- 使用AST生成渲染函数。

由于静态节点不需要总是重新渲染，所以在生成AST之后、生成渲染函数之前这个节点，需要做一个操作，那就说遍历一遍AST，给所有静态节点做一个标记，这样在虚拟DOM中更新节点时，如果发现节点有这个标记，就不会重新渲染它。

这三部分内容在模板编译中分别抽象出三个模块来实现各自的功能

- 解析器
- 优化器
- 代码生成器

## **解析器**

作用：将模板解析成AST。在解析器内部，分成了很多小解析器，其中包括过滤器解析器、文本解析器和HTML解析器。然后通过一条主线将这些解析器组装在一起。在使用模板时，我们可以在其中使用过滤器，而过滤器解析器的作用就说用来解析过滤器的。文本解析器就是用来解析文本的。其主要作用是用来解析带变量的文本。不带变量的文本是一段纯文本，不需要使用文本解析器来解析。

## 优化器

目标：遍历AST，检测出所有静态子树（永远都不会发生变化的DOM节点）并给其打标记。当AST中的静态子树被打上标记后，每次重新渲染时，就不需要为打上标记的静态节点创建新的虚拟节点，而是直接克隆已存在的虚拟节点。在虚拟DOM的更新操作中，如果发现两个是同一个节点，正常情况下会对这两个节点进行更新，但是如果这两个节点是静态节点，则可以直接跳过更新节点的流程。优化器的主要作用是避免一些无用功来提升性能。因为静态节点出了首次渲染，后续不需要任何重新渲染操作。

## **代码生成器**

其是模板编译的最后一步，作用是将AST转换成渲染函数中的内容，这个内容可以称为“代码字符串”。这样一个代码字符串最终导出到外界使用时，会将代码字符串放到函数里，这个函数叫作渲染函数。当渲染函数被导出到外界后，模板编译的任务就完成了。渲染函数的作用是创建vnode。渲染函数之所以可以生成vnode，是因为代码字符串中会有很多函数调用（例如，上面生成的代码字符串中有两个函数调用_c 和 _v），这些函数是虚拟DOM提供的创建vnode的方法。vnode有很多种类型，不同类型对应不同的创建方法，所以代码字符串中的_c 和 _v其实都是创建vnode的方法，只是创建vnode的类型不同，例如_c 可以创建元素类型的vnode，而 _v可以创建文本类型的vnode。

```html
<p title="Berwin" @click="c">1</p>
```

```javascript
with(this){
    return _c(
        'p',
        {
            attrs:{"title""Berwin"},
            on:{"click":c}
        },
        [_v("1")] 
    )
}
```

```javascript
const code = 'with(this){return 'Hello Berwin'}';
const hello = new Function(code);
hello();
//Hello Berwin
```

